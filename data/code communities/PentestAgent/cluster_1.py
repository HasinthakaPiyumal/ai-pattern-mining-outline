# Cluster 1

def auto_discover_tool_path(server):
    """Auto-discover tool path with user confirmation"""
    if not server.get('exe_name'):
        return None
    print(f'{Fore.CYAN}Searching for {server['name']}...{Style.RESET_ALL}')
    search_variants = get_tool_search_variants(server['exe_name'])
    found_path = None
    for variant in search_variants:
        found_path = find_tool_path(variant)
        if found_path:
            break
    if found_path:
        print(f'{Fore.GREEN}Found: {found_path}{Style.RESET_ALL}')
        choice = input(f'   Use this path? (yes/no): ').strip().lower()
        if choice == 'y' or choice == 'yes':
            return found_path
    else:
        print(f'{Fore.YELLOW}{server['name']} not found in PATH{Style.RESET_ALL}')
    manual_path = input(f'   Enter path to {server['exe_name']} manually (or press Enter to skip): ').strip()
    return manual_path if manual_path else None

def get_tool_search_variants(exe_name):
    """Get different variants of tool names to search for"""
    if not exe_name:
        return []
    base_name = exe_name.replace('.exe', '').replace('.py', '')
    variants = [base_name]
    if exe_name != base_name:
        variants.append(exe_name)
    return variants

def find_tool_path(tool_name):
    """Auto-discover tool path using system commands"""
    try:
        if platform.system() == 'Windows':
            result = subprocess.run(['where', tool_name], capture_output=True, text=True, check=False)
            if result.returncode == 0:
                paths = result.stdout.strip().split('\n')
                for path in paths:
                    path = path.strip()
                    if path and os.path.exists(path):
                        return path
        else:
            path = shutil.which(tool_name)
            if path and os.path.exists(path):
                return path
    except Exception:
        pass
    return None

def main():
    print(f'{Fore.GREEN}===================== GHOSTCREW MCP SERVER CONFIGURATION ====================={Style.RESET_ALL}')
    print(f'{Fore.YELLOW}This tool will help you configure the MCP servers for your GHOSTCREW installation.{Style.RESET_ALL}')
    print(f'{Fore.CYAN}Auto-discovery will attempt to find tools automatically in your system PATH.{Style.RESET_ALL}')
    print(f'{Fore.CYAN}You can confirm, decline, or provide custom paths as needed.{Style.RESET_ALL}')
    print()
    if not check_npm_installed():
        print(f"{Fore.RED}Warning: npm doesn't appear to be installed. MCP servers use Node.js and npm.{Style.RESET_ALL}")
        print(f'{Fore.YELLOW}You may need to install Node.js from: https://nodejs.org/{Style.RESET_ALL}')
        cont = input(f'{Fore.YELLOW}Continue anyway? (yes/no): {Style.RESET_ALL}').strip().lower()
        if cont != 'yes':
            print(f'{Fore.RED}Configuration cancelled.{Style.RESET_ALL}')
            return
    mcp_config = {'servers': []}
    if os.path.exists('mcp.json'):
        try:
            with open('mcp.json', 'r') as f:
                mcp_config = json.load(f)
                print(f'{Fore.GREEN}Loaded existing mcp.json with {len(mcp_config.get('servers', []))} server configurations.{Style.RESET_ALL}')
        except:
            print(f'{Fore.RED}Error loading existing mcp.json. Starting with empty configuration.{Style.RESET_ALL}')
    configured_servers = []
    print(f'{Fore.CYAN}Available tools:{Style.RESET_ALL}')
    for i, server in enumerate(MCP_SERVERS):
        print(f'{i + 1}. {server['name']} - {server['description']}')
    print()
    print(f"{Fore.YELLOW}Select tools to configure (comma-separated numbers, 'all' for all tools, or 'none' to skip):{Style.RESET_ALL}")
    selection = input().strip().lower()
    selected_indices = []
    if selection == 'all':
        selected_indices = list(range(len(MCP_SERVERS)))
    elif selection != 'none':
        try:
            for part in selection.split(','):
                idx = int(part.strip()) - 1
                if 0 <= idx < len(MCP_SERVERS):
                    selected_indices.append(idx)
        except:
            print(f'{Fore.RED}Invalid selection. Please enter comma-separated numbers.{Style.RESET_ALL}')
            return
    for idx in selected_indices:
        server = MCP_SERVERS[idx]
        print(f'\n{Fore.CYAN}Configuring {server['name']}:{Style.RESET_ALL}')
        env_vars = {}
        if server.get('exe_name'):
            exe_path = auto_discover_tool_path(server)
            if exe_path:
                if not os.path.exists(exe_path):
                    print(f'{Fore.YELLOW}Warning: The specified path does not exist: {exe_path}{Style.RESET_ALL}')
                    cont = input(f'   Continue anyway? (yes/no, default: no): ').strip().lower()
                    if cont != 'yes':
                        print(f'   {Fore.YELLOW}Skipping {server['name']}.{Style.RESET_ALL}')
                        continue
                if server.get('env_var'):
                    env_vars[server['env_var']] = exe_path
            else:
                print(f'{Fore.YELLOW}Skipping {server['name']} - executable not found.{Style.RESET_ALL}')
                continue
        elif server.get('env_var'):
            value = input(f'Enter value for {server['env_var']} (default: ): ').strip()
            if value:
                env_vars[server['env_var']] = value
            else:
                print(f'{Fore.YELLOW}Skipping {server['name']} - {server['env_var']} required.{Style.RESET_ALL}')
                continue
        else:
            print(f'{Fore.GREEN}{server['name']} requires no local executable.{Style.RESET_ALL}')
        if 'env_extra' in server:
            for extra_var, default_value in server['env_extra'].items():
                if extra_var == 'MASSDNS_PATH':
                    print(f'\n{Fore.CYAN}Also configuring massdns for {server['name']}...{Style.RESET_ALL}')
                    print(f'{Fore.CYAN}Searching for massdns...{Style.RESET_ALL}')
                    massdns_path = find_tool_path('massdns')
                    if massdns_path:
                        print(f'{Fore.GREEN}Found: {massdns_path}{Style.RESET_ALL}')
                        choice = input(f'   Use this path? (yes/no): ').strip().lower()
                        if choice != 'y' and choice != 'yes':
                            massdns_path = input(f'   Enter path to massdns manually: ').strip()
                    else:
                        print(f'{Fore.YELLOW}massdns not found in PATH{Style.RESET_ALL}')
                        massdns_path = input(f'   Enter path to massdns manually (or press Enter to skip): ').strip()
                    if massdns_path:
                        env_vars[extra_var] = massdns_path
                    else:
                        print(f'{Fore.YELLOW}Skipping {server['name']} - massdns path required.{Style.RESET_ALL}')
                        continue
                else:
                    value = input(f'Enter value for {extra_var} (default: {default_value}): ').strip()
                    env_vars[extra_var] = value if value else default_value
        configured_servers.append({'name': server['name'], 'params': {'command': server['command'], 'args': server['args'], 'env': env_vars}, 'cache_tools_list': True})
        print(f'{Fore.GREEN}{server['name']} configured successfully!{Style.RESET_ALL}')
    if 'servers' not in mcp_config:
        mcp_config['servers'] = []
    if configured_servers:
        if mcp_config['servers']:
            replace = input(f'{Fore.YELLOW}Replace existing configurations or append new ones? (replace/append, default: append): {Style.RESET_ALL}').strip().lower()
            if replace == 'replace':
                mcp_config['servers'] = configured_servers
            else:
                existing_names = [s['name'] for s in mcp_config['servers']]
                for server in configured_servers:
                    if server['name'] in existing_names:
                        idx = existing_names.index(server['name'])
                        mcp_config['servers'][idx] = server
                    else:
                        mcp_config['servers'].append(server)
        else:
            mcp_config['servers'] = configured_servers
        with open('mcp.json', 'w') as f:
            json.dump(mcp_config, f, indent=2)
        print(f'\n{Fore.GREEN}Configuration saved to mcp.json with {len(mcp_config['servers'])} server configurations.{Style.RESET_ALL}')
        print(f'{Fore.YELLOW}You can now run the main application with: python main.py{Style.RESET_ALL}')
    else:
        print(f'\n{Fore.YELLOW}No tools were configured. Keeping existing configuration.{Style.RESET_ALL}')

def check_npm_installed():
    """Check if npm is installed"""
    try:
        result = shutil.which('npm')
        return result is not None
    except:
        return False

