# Cluster 3

def sub_loop(model_fn, model_scope, model_dir, run_config, train_epochs, epochs_per_eval, lr_decay_factors, decay_boundaries, checkpoint_path=None, checkpoint_exclude_scopes='', checkpoint_model_scope='', ignore_missing_vars=True):
    steps_per_epoch = config.split_size[model_scope if 'all' not in model_scope else '*']['train'] // FLAGS.batch_size
    fashionAI = tf.estimator.Estimator(model_fn=model_fn, model_dir=model_dir, config=run_config, params={'checkpoint_path': checkpoint_path, 'model_dir': model_dir, 'checkpoint_exclude_scopes': checkpoint_exclude_scopes, 'model_scope': model_scope, 'checkpoint_model_scope': checkpoint_model_scope, 'ignore_missing_vars': ignore_missing_vars, 'train_image_size': FLAGS.train_image_size, 'heatmap_size': FLAGS.heatmap_size, 'data_format': FLAGS.data_format, 'steps_per_epoch': steps_per_epoch, 'use_ohkm': FLAGS.use_ohkm, 'batch_size': FLAGS.batch_size, 'weight_decay': FLAGS.weight_decay, 'mse_weight': FLAGS.mse_weight, 'momentum': FLAGS.momentum, 'learning_rate': FLAGS.learning_rate, 'end_learning_rate': FLAGS.end_learning_rate, 'warmup_learning_rate': FLAGS.warmup_learning_rate, 'warmup_steps': FLAGS.warmup_steps, 'decay_boundaries': parse_comma_list(decay_boundaries), 'lr_decay_factors': parse_comma_list(lr_decay_factors)})
    tf.gfile.MakeDirs(model_dir)
    tf.logging.info('Starting to train model {}.'.format(model_scope))
    for _ in range(train_epochs // epochs_per_eval):
        tensors_to_log = {'lr': 'learning_rate', 'loss': 'total_loss', 'mse': 'mse_loss', 'ne': 'ne_mertric'}
        logging_hook = tf.train.LoggingTensorHook(tensors=tensors_to_log, every_n_iter=FLAGS.log_every_n_steps, formatter=lambda dicts: '{}:'.format(model_scope) + ', '.join(['%s=%.6f' % (k, v) for k, v in dicts.items()]))
        tf.logging.info('Starting a training cycle.')
        fashionAI.train(input_fn=lambda: input_pipeline(True, model_scope, epochs_per_eval), hooks=[logging_hook], max_steps=steps_per_epoch * train_epochs)
        tf.logging.info('Starting to evaluate.')
        eval_results = fashionAI.evaluate(input_fn=lambda: input_pipeline(False, model_scope, 1))
        tf.logging.info(eval_results)
    tf.logging.info('Finished model {}.'.format(model_scope))

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    if FLAGS.seq_train:
        detail_params = {'all': {'model_dir': os.path.join(FLAGS.model_dir, 'all'), 'train_epochs': 6, 'epochs_per_eval': 4, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '3, 4', 'model_scope': 'all', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'blouse/additional_layer, blouse/feature_pyramid/conv_heatmap, blouse/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'dress/additional_layer, dress/feature_pyramid/conv_heatmap, dress/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'outwear/additional_layer, outwear/feature_pyramid/conv_heatmap, outwear/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'skirt/additional_layer, skirt/feature_pyramid/conv_heatmap, skirt/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'trousers/additional_layer, trousers/feature_pyramid/conv_heatmap, trousers/global_net/conv_heatmap', 'ignore_missing_vars': True}}
    else:
        detail_params = {'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/additional_layer, blouse/feature_pyramid, blouse/global_net', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/additional_layer, dress/feature_pyramid, dress/global_net', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/additional_layer, outwear/feature_pyramid, outwear/global_net', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/additional_layer, skirt/feature_pyramid, skirt/global_net', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/additional_layer, trousers/feature_pyramid, trousers/global_net', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    if FLAGS.seq_train:
        detail_params = {'all': {'model_dir': os.path.join(FLAGS.model_dir, 'all'), 'train_epochs': 6, 'epochs_per_eval': 4, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '3, 4', 'model_scope': 'all', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'blouse/feature_pyramid/conv_heatmap, blouse/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'dress/feature_pyramid/conv_heatmap, dress/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'outwear/feature_pyramid/conv_heatmap, outwear/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'skirt/feature_pyramid/conv_heatmap, skirt/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'trousers/feature_pyramid/conv_heatmap, trousers/global_net/conv_heatmap', 'ignore_missing_vars': True}}
    else:
        detail_params = {'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/feature_pyramid, blouse/global_net', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/feature_pyramid, dress/global_net', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/feature_pyramid, outwear/global_net', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/feature_pyramid, skirt/global_net', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/feature_pyramid, trousers/global_net', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    if FLAGS.seq_train:
        detail_params = {'all': {'model_dir': os.path.join(FLAGS.model_dir, 'all'), 'train_epochs': 6, 'epochs_per_eval': 4, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '3, 4', 'model_scope': 'all', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'blouse/hg_heatmap', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'dress/hg_heatmap', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'outwear/hg_heatmap', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'skirt/hg_heatmap', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'trousers/hg_heatmap', 'ignore_missing_vars': True}}
    else:
        detail_params = {'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 40, 'epochs_per_eval': 15, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'blouse', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 40, 'epochs_per_eval': 15, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'dress', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 40, 'epochs_per_eval': 15, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'outwear', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 40, 'epochs_per_eval': 15, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'skirt', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 40, 'epochs_per_eval': 15, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'trousers', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    if FLAGS.seq_train:
        detail_params = {'all': {'model_dir': os.path.join(FLAGS.model_dir, 'all'), 'train_epochs': 6, 'epochs_per_eval': 4, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '3, 4', 'model_scope': 'all', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'blouse/additional_layer, blouse/feature_pyramid/conv_heatmap, blouse/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'dress/additional_layer, dress/feature_pyramid/conv_heatmap, dress/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'outwear/additional_layer, outwear/feature_pyramid/conv_heatmap, outwear/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'skirt/additional_layer, skirt/feature_pyramid/conv_heatmap, skirt/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'trousers/additional_layer, trousers/feature_pyramid/conv_heatmap, trousers/global_net/conv_heatmap', 'ignore_missing_vars': True}}
    else:
        detail_params = {'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/additional_layer, blouse/feature_pyramid, blouse/global_net', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/additional_layer, dress/feature_pyramid, dress/global_net', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/additional_layer, outwear/feature_pyramid, outwear/global_net', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/additional_layer, skirt/feature_pyramid, skirt/global_net', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/additional_layer, trousers/feature_pyramid, trousers/global_net', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    if FLAGS.seq_train:
        detail_params = {'all': {'model_dir': os.path.join(FLAGS.model_dir, 'all'), 'train_epochs': 6, 'epochs_per_eval': 4, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '3, 4', 'model_scope': 'all', 'checkpoint_path': None, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': '', 'ignore_missing_vars': True}, 'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'blouse/feature_pyramid/conv_heatmap, blouse/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'dress/feature_pyramid/conv_heatmap, dress/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'outwear/feature_pyramid/conv_heatmap, outwear/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'skirt/feature_pyramid/conv_heatmap, skirt/global_net/conv_heatmap', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 50, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 30', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.model_dir, 'all'), 'checkpoint_model_scope': 'all', 'checkpoint_exclude_scopes': 'trousers/feature_pyramid/conv_heatmap, trousers/global_net/conv_heatmap', 'ignore_missing_vars': True}}
    else:
        detail_params = {'blouse': {'model_dir': os.path.join(FLAGS.model_dir, 'blouse'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.backbone) if FLAGS.run_on_cloud else os.path.join(FLAGS.checkpoint_path, FLAGS.backbone), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/feature_pyramid, blouse/global_net', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(FLAGS.model_dir, 'dress'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.backbone) if FLAGS.run_on_cloud else os.path.join(FLAGS.checkpoint_path, FLAGS.backbone), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/feature_pyramid, dress/global_net', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(FLAGS.model_dir, 'outwear'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.backbone) if FLAGS.run_on_cloud else os.path.join(FLAGS.checkpoint_path, FLAGS.backbone), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/feature_pyramid, outwear/global_net', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(FLAGS.model_dir, 'skirt'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.backbone) if FLAGS.run_on_cloud else os.path.join(FLAGS.checkpoint_path, FLAGS.backbone), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/feature_pyramid, skirt/global_net', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(FLAGS.model_dir, 'trousers'), 'train_epochs': 28, 'epochs_per_eval': 7, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '10, 20', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.backbone) if FLAGS.run_on_cloud else os.path.join(FLAGS.checkpoint_path, FLAGS.backbone), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/feature_pyramid, trousers/global_net', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=FLAGS.save_checkpoints_secs).replace(save_checkpoints_steps=None).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    full_model_dir = os.path.join(FLAGS.model_dir, all_models[FLAGS.backbone.strip()]['logs_sub_dir'])
    checkpoint_model_dir = os.path.join(FLAGS.model_dir, all_models[FLAGS.backbone.strip()]['checkpoint_root'])
    detail_params = {'blouse': {'model_dir': os.path.join(full_model_dir, 'blouse'), 'train_epochs': FLAGS.train_epochs, 'model_scope': 'blouse', 'high_learning_rate': FLAGS.high_learning_rate, 'low_learning_rate': FLAGS.low_learning_rate, 'checkpoint_path': os.path.join(checkpoint_model_dir, 'blouse')}, 'dress': {'model_dir': os.path.join(full_model_dir, 'dress'), 'train_epochs': FLAGS.train_epochs, 'model_scope': 'dress', 'high_learning_rate': FLAGS.high_learning_rate, 'low_learning_rate': FLAGS.low_learning_rate, 'checkpoint_path': os.path.join(checkpoint_model_dir, 'dress')}, 'outwear': {'model_dir': os.path.join(full_model_dir, 'outwear'), 'train_epochs': FLAGS.train_epochs, 'model_scope': 'outwear', 'high_learning_rate': FLAGS.high_learning_rate, 'low_learning_rate': FLAGS.low_learning_rate, 'checkpoint_path': os.path.join(checkpoint_model_dir, 'outwear')}, 'skirt': {'model_dir': os.path.join(full_model_dir, 'skirt'), 'train_epochs': FLAGS.train_epochs, 'model_scope': 'skirt', 'high_learning_rate': FLAGS.high_learning_rate, 'low_learning_rate': FLAGS.low_learning_rate, 'checkpoint_path': os.path.join(checkpoint_model_dir, 'skirt')}, 'trousers': {'model_dir': os.path.join(full_model_dir, 'trousers'), 'train_epochs': FLAGS.train_epochs, 'high_learning_rate': FLAGS.high_learning_rate, 'low_learning_rate': FLAGS.low_learning_rate, 'model_scope': 'trousers', 'checkpoint_path': os.path.join(checkpoint_model_dir, 'trousers')}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['high_learning_rate'], detail_params[m]['low_learning_rate'], detail_params[m]['checkpoint_path'])

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=None).replace(save_checkpoints_steps=FLAGS.save_checkpoints_steps).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    num_gpus = validate_batch_size_for_multi_gpu(FLAGS.batch_size)
    full_model_dir = FLAGS.model_dir if FLAGS.run_on_cloud else FLAGS.model_dir
    detail_params = {'blouse': {'model_dir': os.path.join(full_model_dir, 'blouse'), 'train_epochs': 30, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1, 0.01', 'decay_boundaries': '15, 20, 28', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/additional_layer', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(full_model_dir, 'dress'), 'train_epochs': 30, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1, 0.01', 'decay_boundaries': '15, 20, 28', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/additional_layer', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(full_model_dir, 'outwear'), 'train_epochs': 30, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1, 0.01', 'decay_boundaries': '15, 20, 28', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/additional_layer', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(full_model_dir, 'skirt'), 'train_epochs': 30, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1, 0.01', 'decay_boundaries': '15, 20, 28', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/additional_layer', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(full_model_dir, 'trousers'), 'train_epochs': 30, 'epochs_per_eval': 30, 'lr_decay_factors': '1, 0.5, 0.1, 0.01', 'decay_boundaries': '15, 20, 28', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path) if FLAGS.run_on_cloud else FLAGS.checkpoint_path, 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/additional_layer', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

def validate_batch_size_for_multi_gpu(batch_size):
    """For multi-gpu, batch-size must be a multiple of the number of
    available GPUs.

    Note that this should eventually be handled by replicate_model_fn
    directly. Multi-GPU support is currently experimental, however,
    so doing the work here until that feature is in place.
    """
    if not FLAGS.multi_gpu:
        return 0
    from tensorflow.python.client import device_lib
    local_device_protos = device_lib.list_local_devices()
    num_gpus = sum([1 for d in local_device_protos if d.device_type == 'GPU'])
    if not num_gpus:
        raise ValueError('Multi-GPU mode was specified, but no GPUs were found. To use CPU, run without --multi_gpu=False.')
    remainder = batch_size % num_gpus
    if remainder:
        err = 'When running with multiple GPUs, batch size must be a multiple of the number of available GPUs. Found {} GPUs with a batch size of {}; try --batch_size={} instead.'.format(num_gpus, batch_size, batch_size - remainder)
        raise ValueError(err)
    return num_gpus

def main(_):
    os.environ['TF_ENABLE_WINOGRAD_NONFUSED'] = '1'
    gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=FLAGS.gpu_memory_fraction)
    sess_config = tf.ConfigProto(allow_soft_placement=True, log_device_placement=False, intra_op_parallelism_threads=FLAGS.num_cpu_threads, inter_op_parallelism_threads=FLAGS.num_cpu_threads, gpu_options=gpu_options)
    run_config = tf.estimator.RunConfig().replace(save_checkpoints_secs=None).replace(save_checkpoints_steps=FLAGS.save_checkpoints_steps).replace(save_summary_steps=FLAGS.save_summary_steps).replace(keep_checkpoint_max=5).replace(tf_random_seed=FLAGS.tf_random_seed).replace(log_step_count_steps=FLAGS.log_every_n_steps).replace(session_config=sess_config)
    num_gpus = validate_batch_size_for_multi_gpu(FLAGS.batch_size)
    full_model_dir = FLAGS.model_dir if FLAGS.run_on_cloud else FLAGS.model_dir.format(FLAGS.backbone.strip())
    detail_params = {'blouse': {'model_dir': os.path.join(full_model_dir, 'blouse'), 'train_epochs': 25, 'epochs_per_eval': 5, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 20', 'model_scope': 'blouse', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path.format(FLAGS.net_depth)) if FLAGS.run_on_cloud else FLAGS.checkpoint_path.format(FLAGS.net_depth), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'blouse/additional_layer, blouse/feature_pyramid, blouse/global_net', 'ignore_missing_vars': True}, 'dress': {'model_dir': os.path.join(full_model_dir, 'dress'), 'train_epochs': 25, 'epochs_per_eval': 5, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 20', 'model_scope': 'dress', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path.format(FLAGS.net_depth)) if FLAGS.run_on_cloud else FLAGS.checkpoint_path.format(FLAGS.net_depth), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'dress/additional_layer, dress/feature_pyramid, dress/global_net', 'ignore_missing_vars': True}, 'outwear': {'model_dir': os.path.join(full_model_dir, 'outwear'), 'train_epochs': 25, 'epochs_per_eval': 5, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 20', 'model_scope': 'outwear', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path.format(FLAGS.net_depth)) if FLAGS.run_on_cloud else FLAGS.checkpoint_path.format(FLAGS.net_depth), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'outwear/additional_layer, outwear/feature_pyramid, outwear/global_net', 'ignore_missing_vars': True}, 'skirt': {'model_dir': os.path.join(full_model_dir, 'skirt'), 'train_epochs': 25, 'epochs_per_eval': 5, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 20', 'model_scope': 'skirt', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path.format(FLAGS.net_depth)) if FLAGS.run_on_cloud else FLAGS.checkpoint_path.format(FLAGS.net_depth), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'skirt/additional_layer, skirt/feature_pyramid, skirt/global_net', 'ignore_missing_vars': True}, 'trousers': {'model_dir': os.path.join(full_model_dir, 'trousers'), 'train_epochs': 25, 'epochs_per_eval': 5, 'lr_decay_factors': '1, 0.5, 0.1', 'decay_boundaries': '15, 20', 'model_scope': 'trousers', 'checkpoint_path': os.path.join(FLAGS.data_dir, FLAGS.cloud_checkpoint_path.format(FLAGS.net_depth)) if FLAGS.run_on_cloud else FLAGS.checkpoint_path.format(FLAGS.net_depth), 'checkpoint_model_scope': '', 'checkpoint_exclude_scopes': 'trousers/additional_layer, trousers/feature_pyramid, trousers/global_net', 'ignore_missing_vars': True}}
    model_to_train = [s.strip() for s in FLAGS.model_to_train.split(',')]
    for m in model_to_train:
        sub_loop(keypoint_model_fn, m, detail_params[m]['model_dir'], run_config, detail_params[m]['train_epochs'], detail_params[m]['epochs_per_eval'], detail_params[m]['lr_decay_factors'], detail_params[m]['decay_boundaries'], detail_params[m]['checkpoint_path'], detail_params[m]['checkpoint_exclude_scopes'], detail_params[m]['checkpoint_model_scope'], detail_params[m]['ignore_missing_vars'])

